```html
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Asistente Educativo ‚Äì Dolor Lumbar Cr√≥nico</title>

  <style>
    :root{
      --uem-red:#7A0000;
      --uem-red-2:#5a0000;
      --bg:#f4f6f8;
      --card:#ffffff;
      --ink:#1f2328;
      --muted:#667085;
      --border:rgba(16,24,40,.12);
      --shadow:0 14px 34px rgba(16,24,40,.12);
      --radius:18px;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:"Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* HEADER */
    header{
      position:sticky;
      top:0;
      z-index:20;
      display:flex;
      align-items:center;
      gap:14px;
      padding:14px 18px;
      background:linear-gradient(90deg, var(--uem-red), #8d1111);
      color:#fff;
      box-shadow:0 4px 14px rgba(0,0,0,.18);
    }
    header img{ height:48px; width:auto; display:block; }
    .hdrText{ display:flex; flex-direction:column; gap:2px; line-height:1.2; }
    .hdrText strong{ font-size:16px; font-weight:700; }
    .hdrText span{ font-size:12px; opacity:.92; }

    /* LAYOUT */
    main{
      max-width:1120px;
      margin:0 auto;
      padding:18px 16px 16px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    /* PANEL IZQUIERDO */
    .panel{ padding:16px; }
    .panel h2{
      margin:0 0 10px;
      color:var(--uem-red);
      font-size:16px;
      letter-spacing:.2px;
    }
    .panel p{
      margin:10px 0;
      line-height:1.55;
      color:#2b2f36;
      font-size:14px;
    }
    .callout{
      margin-top:12px;
      padding:12px 12px;
      border-radius:16px;
      background:rgba(122,0,0,.06);
      border:1px solid rgba(122,0,0,.18);
      color:#2b2f36;
      font-size:13px;
      line-height:1.45;
    }
    .imgWrap{
      margin-top:14px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
    }
    .imgWrap img{ width:100%; height:auto; display:block; }

    .warn{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(255,235,235,.85);
      border:1px solid rgba(122,0,0,.22);
      color:#5a0000;
      font-size:13px;
      display:none;
      line-height:1.4;
    }

    /* CHAT */
    .chat{
      display:flex;
      flex-direction:column;
      height: 78vh;
      min-height:560px;
    }
    .chatHeader{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.22);
      background:linear-gradient(90deg, rgba(122,0,0,.98), rgba(141,17,17,.98));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .chatHeader .left{
      display:flex;
      flex-direction:column;
      gap:2px;
      line-height:1.15;
    }
    .chatHeader .left strong{ font-size:15px; }
    .chatHeader .left span{ font-size:12px; opacity:.92; }

    .toggles{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .switch{
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-size:12px;
      opacity:.95;
      white-space:nowrap;
      user-select:none;
    }
    .switch input{ transform: translateY(1px); }

    /* Bot√≥n redondo en header (reset) */
    .headerIconBtn{
      width:34px;
      height:34px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.45);
      background:rgba(255,255,255,.10);
      color:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:17px;
      line-height:1;
      user-select:none;
    }
    .headerIconBtn:hover{
      background:rgba(255,255,255,.18);
      border-color:rgba(255,255,255,.65);
    }

    .chatBody{
      flex:1;
      overflow:auto;
      padding:16px;
      background:
        radial-gradient(900px 260px at 10% 0%, rgba(122,0,0,.06), transparent 60%),
        radial-gradient(700px 220px at 90% 10%, rgba(122,0,0,.05), transparent 55%),
        #ffffff;
    }

    .msg{
      max-width: 86%;
      padding:11px 12px;
      border-radius:16px;
      margin:10px 0;
      line-height:1.48;
      font-size:14px;
      box-shadow:0 8px 18px rgba(16,24,40,.08);
      border:1px solid rgba(16,24,40,.08);
      white-space:normal;
      word-wrap:break-word;
    }
    .msg.user{
      margin-left:auto;
      background:rgba(122,0,0,.08);
      border-color: rgba(122,0,0,.18);
    }
    .msg.bot{
      margin-right:auto;
      background:#f7f8fa;
    }
    .meta{
      margin-top:8px;
      font-size:11px;
      color:#667085;
    }

    .typing{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:10px 12px;
      border-radius:16px;
      background:#f7f8fa;
      border:1px solid rgba(16,24,40,.08);
      box-shadow:0 8px 18px rgba(16,24,40,.06);
      font-size:13px;
      color:#667085;
      width:max-content;
      max-width:86%;
    }
    .dot{
      width:6px; height:6px; border-radius:999px;
      background:#667085;
      display:inline-block;
      animation: blink 1.2s infinite;
      opacity:.4;
    }
    .dot:nth-child(2){ animation-delay:.2s; }
    .dot:nth-child(3){ animation-delay:.4s; }
    @keyframes blink{
      0%, 100%{ opacity:.25; transform:translateY(0); }
      50%{ opacity:.85; transform:translateY(-1px); }
    }

    .chatFooter{
      padding:12px;
      border-top:1px solid rgba(16,24,40,.08);
      background:#fff;
      display:flex;
      gap:10px;
      align-items:flex-end;
    }

    /* Botones redondos con icono (footer) */
    .iconBtn{
      width:44px;
      height:44px;
      border-radius:999px;
      border:1px solid rgba(16,24,40,.16);
      background:#fff;
      color:var(--uem-red);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      box-shadow:0 6px 14px rgba(16,24,40,.08);
      user-select:none;
    }
    .iconBtn:hover{
      background:rgba(122,0,0,.06);
      border-color: rgba(122,0,0,.28);
    }
    .iconBtn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .iconBtn.recording{
      background:rgba(122,0,0,.10);
      border-color: rgba(122,0,0,.45);
      box-shadow:0 0 0 4px rgba(122,0,0,.10), 0 6px 14px rgba(16,24,40,.08);
    }
    .iconBtn svg, .headerIconBtn svg{
      width:20px;
      height:20px;
      stroke:currentColor;
      stroke-width:2;
      stroke-linecap:round;
      stroke-linejoin:round;
      fill:none;
    }
    .headerIconBtn svg{
      width:18px;
      height:18px;
    }
    .switch svg{
      width:16px;
      height:16px;
      stroke:currentColor;
      stroke-width:2;
      stroke-linecap:round;
      stroke-linejoin:round;
      fill:none;
      vertical-align:middle;
      margin-right:4px;
    }

    textarea{
      flex:1;
      resize:none;
      border-radius:14px;
      border:1px solid rgba(16,24,40,.16);
      padding:10px 12px;
      font-family:inherit;
      font-size:14px;
      min-height:44px;
      max-height:140px;
      outline:none;
      line-height:1.4;
    }
    textarea:focus{
      border-color: rgba(122,0,0,.45);
      box-shadow:0 0 0 4px rgba(122,0,0,.10);
    }

    .sendBtn{
      border:none;
      border-radius:12px;
      padding:11px 14px;
      font-weight:700;
      cursor:pointer;
      background:var(--uem-red);
      color:#fff;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .sendBtn:hover{ background:var(--uem-red-2); }
    .sendBtn:disabled{ opacity:.65; cursor:not-allowed; }

    /* FOOTER */
    footer{
      text-align:center;
      padding:14px 16px 10px;
      font-size:12px;
      color:var(--muted);
    }
    .authors{
      text-align:center;
      padding:0 16px 18px;
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
      max-width:1120px;
      margin:0 auto;
    }
    .authors strong{ color:#475467; font-weight:700; }
  </style>
</head>

<body>
  <header>
    <img src="logo-uem.png" alt="Universidad Europea" />
    <div class="hdrText">
      <strong>Asistente Educativo ‚Äì Dolor Lumbar Cr√≥nico</strong>
      <span>Herramienta acad√©mica ¬∑ Uso educativo</span>
    </div>
  </header>

  <main>
    <!-- PANEL IZQUIERDO: INFO + IMAGEN -->
    <section class="card panel">
      <h2>Informaci√≥n del proyecto</h2>

      <p>
        Este asistente virtual ofrece <b>orientaci√≥n educativa</b> sobre dolor lumbar cr√≥nico.
        No sustituye una consulta m√©dica ni una valoraci√≥n profesional.
      </p>

      <div class="callout">
        <b>üîí Privacidad y RGPD</b><br>
        ‚Ä¢ No se solicitan datos personales (nombre, DNI, direcci√≥n, tel√©fono, correo, etc.)<br>
        ‚Ä¢ Evite incluir informaci√≥n identificable<br>
        ‚Ä¢ Uso exclusivamente educativo<br>
        ‚Ä¢ Signos de alarma (fiebre, p√©rdida de fuerza, incontinencia, dolor intenso progresivo): consulte de forma urgente
      </div>

      <div class="imgWrap">
        <img src="fondo-lumbar.jpg" alt="Imagen educativa sobre dolor lumbar" />
      </div>

      <div id="warnBox" class="warn"></div>
    </section>

    <!-- CHAT -->
    <section class="card chat">
      <div class="chatHeader">
        <div class="left">
          <strong>Chat educativo</strong>
          <span>Respuestas claras ¬∑ En espa√±ol ¬∑ Orientaci√≥n general</span>
        </div>
        <div class="toggles">
          <label class="switch">
            <input id="ttsToggle" type="checkbox" checked>
            <svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
            Leer respuestas
          </label>
          <button id="resetBtn" class="headerIconBtn" type="button" title="Reiniciar chat"><svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg></button>
        </div>
      </div>

      <div id="chatBody" class="chatBody" aria-live="polite"></div>

      <div class="chatFooter">
        <button id="micBtn" class="iconBtn" type="button" title="Dictado por voz"><svg viewBox="0 0 24 24"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg></button>
        <button id="stopTtsBtn" class="iconBtn" type="button" title="Parar voz"><svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="22" x2="16" y1="9" y2="15"/><line x1="16" x2="22" y1="9" y2="15"/></svg></button>

        <textarea id="textIn" placeholder="Escribe tu pregunta (sin datos personales)..." rows="1"></textarea>
        <button id="sendBtn" class="sendBtn" type="button">Enviar</button>
      </div>
    </section>
  </main>

  <footer>Proyecto acad√©mico ‚Äî Universidad Europea de Madrid</footer>
  <div class="authors">
    <strong>Autores:</strong>
    Paloma Romero Mart√≠n, Raquel Guti√©rrez Gonz√°lez, Mar√≠a Carolina Rodr√≠guez Latorre,
    Mar√≠a Teresa Blanco Benitez y Carlos Manuel Cardozo Zepeda.
  </div>

<script>
  // =============================
  // CONFIG FLOWISE (texto)
  // =============================
  const FLOWISE_HOST = "https://cloud.flowiseai.com";
  const CHATFLOW_ID  = "d845e868-e00f-4d54-a291-8e9364b05473";
  const FLOWISE_PREDICT_URL = `${FLOWISE_HOST}/api/v1/prediction/${CHATFLOW_ID}`;
  const chatId = (crypto?.randomUUID?.() || String(Date.now())) + "-uem";

  // =============================
  // UI
  // =============================
  const chatBody = document.getElementById("chatBody");
  const textIn = document.getElementById("textIn");
  const sendBtn = document.getElementById("sendBtn");
  const micBtn = document.getElementById("micBtn");
  const stopTtsBtn = document.getElementById("stopTtsBtn");
  const ttsToggle = document.getElementById("ttsToggle");
  const resetBtn = document.getElementById("resetBtn");
  const warnBox = document.getElementById("warnBox");

  function setWarn(msg){
    warnBox.style.display = "block";
    warnBox.textContent = msg;
  }
  function clearWarn(){
    warnBox.style.display = "none";
    warnBox.textContent = "";
  }

  // =============================
  // MARKDOWN MINI (negrita + saltos) + speech clean
  // =============================
  function escapeHTML(s){
    return s.replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }
  function mdMiniToHtml(s){
    let t = escapeHTML(String(s ?? ""));
    t = t.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
    t = t.replace(/\n/g, "<br>");
    return t;
  }
  function stripMarkdownForSpeech(s){
    let t = String(s ?? "");
    t = t.replace(/\*\*/g, "");
    t = t.replace(/[*_`#>]/g, "");
    t = t.replace(/\s+/g, " ").trim();
    return t;
  }

  function addMsg(role, text){
    const el = document.createElement("div");
    el.className = `msg ${role}`;
    el.innerHTML = mdMiniToHtml(text);

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = role === "user" ? "T√∫" : "Asistente";
    el.appendChild(meta);

    chatBody.appendChild(el);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  // =============================
  // "Escribiendo..."
  // =============================
  let typingEl = null;
  function showTyping(){
    if(typingEl) return;
    typingEl = document.createElement("div");
    typingEl.className = "typing";
    typingEl.innerHTML = 'Escribiendo <span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    chatBody.appendChild(typingEl);
    chatBody.scrollTop = chatBody.scrollHeight;
  }
  function hideTyping(){
    if(!typingEl) return;
    typingEl.remove();
    typingEl = null;
  }

  // =============================
  // TTS (Texto -> Voz)
  // =============================
  function stopSpeak(){
    if("speechSynthesis" in window) window.speechSynthesis.cancel();
  }
  function speak(text){
    if(!ttsToggle.checked) return;
    if(!("speechSynthesis" in window)){
      setWarn("Tu navegador no soporta lectura en voz. Usa Chrome o Edge.");
      return;
    }
    stopSpeak();
    const clean = stripMarkdownForSpeech(text);
    const u = new SpeechSynthesisUtterance(clean);
    u.lang = "es-ES";
    u.rate = 1;
    u.pitch = 1;
    window.speechSynthesis.speak(u);
  }
  stopTtsBtn.addEventListener("click", stopSpeak);

  // =============================
  // Permiso micr√≥fono (una sola vez)
  // =============================
  let micStream = null;
  async function asegurarPermisoMicrofono(){
    if(micStream) return true;
    try{
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      return true;
    }catch(e){
      setWarn("No se pudo obtener permiso del micr√≥fono. Revisa los permisos del navegador.");
      return false;
    }
  }
  window.addEventListener("beforeunload", ()=>{
    if(micStream){
      micStream.getTracks().forEach(t=>t.stop());
      micStream = null;
    }
  });

  // =============================
  // STT (Voz -> Texto) manual (sin auto-env√≠o)
  // =============================
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  let isRecording = false;
  let finalTranscript = "";

  function autoResize(el){
    el.style.height = "auto";
    el.style.height = Math.min(el.scrollHeight, 140) + "px";
  }
  textIn.addEventListener("input", ()=> autoResize(textIn));

  function initSTT(){
    if(!SpeechRecognition){
      setWarn("Tu navegador no soporta dictado por voz. Usa Chrome o Edge.");
      micBtn.disabled = true;
      return;
    }
    rec = new SpeechRecognition();
    rec.lang = "es-ES";
    rec.continuous = true;
    rec.interimResults = true;

    rec.onstart = () => {
      isRecording = true;
      micBtn.classList.add("recording");
      micBtn.title = "Grabando... (pulsa de nuevo para detener)";
      clearWarn();
    };

    rec.onend = () => {
      // Si el motor corta solo y el usuario sigue en modo grabaci√≥n, reintentamos
      if(isRecording){
        try{ rec.start(); } catch(_) {}
        return;
      }
      micBtn.classList.remove("recording");
      micBtn.title = "Dictado por voz";
    };

    rec.onerror = (e) => {
      const err = e?.error || "desconocido";
      // Si es un corte t√≠pico, reintenta si sigue grabando
      if(isRecording && (err === "no-speech" || err === "network" || err === "audio-capture")){
        try{ rec.stop(); } catch(_) {}
        setTimeout(()=>{ if(isRecording) { try{ rec.start(); } catch(_){} } }, 250);
        return;
      }
      setWarn("No se pudo usar el micr√≥fono. Revisa permisos del navegador. Error: " + err);
      isRecording = false;
      micBtn.classList.remove("recording");
    };

    rec.onresult = (event) => {
      let interim = "";
      let finalChunk = "";

      for(let i = event.resultIndex; i < event.results.length; i++){
        const r = event.results[i];
        const piece = r[0]?.transcript || "";
        if(r.isFinal) finalChunk += piece;
        else interim += piece;
      }

      if(finalChunk.trim()){
        finalTranscript = (finalTranscript + " " + finalChunk).trim();
      }

      const displayText = (finalTranscript + " " + interim).trim();
      if(displayText){
        textIn.value = displayText;
        autoResize(textIn);
      }
    };
  }

  async function startDictation(){
    if(!rec) initSTT();
    if(!rec) return;

    stopSpeak();

    const ok = await asegurarPermisoMicrofono();
    if(!ok) return;

    finalTranscript = (textIn.value || "").trim();
    isRecording = true;

    try{ rec.start(); } catch(_) {}
  }

  function stopDictation(){
    isRecording = false;
    try{ rec.stop(); } catch(_) {}
    micBtn.classList.remove("recording");
    micBtn.title = "Dictado por voz";
  }

  micBtn.addEventListener("click", ()=>{
    if(isRecording) stopDictation();
    else startDictation();
  });

  // =============================
  // FLOWISE CALL
  // =============================
  async function askFlowise(question){
    const res = await fetch(FLOWISE_PREDICT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question, chatId })
    });

    if(!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`Flowise respondi√≥ ${res.status}. ${t}`);
    }

    const data = await res.json();
    const answer = (typeof data === "string")
      ? data
      : (data.text || data.answer || data.response || data.result || "");

    return answer || "No he podido generar una respuesta en este momento.";
  }

  // =============================
  // Env√≠o + guardarra√≠l RGPD
  // =============================
  let busy = false;
  function looksLikePII(s){
    const q = String(s ?? "");
    return /(\b\d{8}[a-zA-Z]\b)|(@)|(\+?\d[\d\s\-]{7,}\d)/.test(q);
  }

  async function send(){
    const q = (textIn.value || "").trim();
    if(!q || busy) return;

    if(looksLikePII(q)){
      addMsg("bot", "Antes de continuar: por favor evita compartir **datos personales** (tel√©fono, correo, DNI u otros identificadores). Puedes reformular tu pregunta de forma general.");
      speak("Antes de continuar: por favor evita compartir datos personales. Puedes reformular tu pregunta de forma general.");
      return;
    }

    addMsg("user", q);
    textIn.value = "";
    autoResize(textIn);
    finalTranscript = "";

    busy = true;
    sendBtn.disabled = true;
    showTyping();

    try{
      const a = await askFlowise(q);
      hideTyping();
      addMsg("bot", a);
      speak(a);
    }catch(err){
      hideTyping();
      addMsg("bot", "No pude conectar con el servicio del chatbot. Si est√°s en GitHub Pages, revisa que Flowise permita CORS para tu dominio.");
      setWarn(String(err?.message || err));
    }finally{
      busy = false;
      sendBtn.disabled = false;
      textIn.focus();
    }
  }

  sendBtn.addEventListener("click", send);
  textIn.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  // =============================
  // Reset chat
  // =============================
  function resetChat(){
    stopSpeak();
    if(isRecording) stopDictation();
    finalTranscript = "";
    textIn.value = "";
    autoResize(textIn);
    hideTyping();
    chatBody.innerHTML = "";
    clearWarn();
    bootMessage();
  }
  resetBtn.addEventListener("click", resetChat);

  // =============================
  // Mensaje inicial
  // =============================
  function bootMessage(){
    addMsg("bot",
      "Hola, me llamo **Lumi**. Estoy aqu√≠ para orientarte con informaci√≥n educativa y apoyo sobre dolor lumbar cr√≥nico, " +
      "complementando (sin sustituir) la valoraci√≥n de profesionales de salud.\n\n" +
      "**Privacidad (RGPD):** no solicito datos personales. ¬øQu√© te gustar√≠a saber?"
    );
    speak("Hola, me llamo Lumi. No solicito datos personales. ¬øQu√© te gustar√≠a saber?");
  }

  bootMessage();

  // Init STT
  initSTT();
</script>
</body>
</html>
```
